<html>
<head>
    <link href="style.css" media="all" rel="stylesheet" data-target="desktop"/>
    <script src="plotly-latest.min.js"></script>
    <script src="jquery.min.js"></script>
</head>
<body>

<div class = "six columns">
        X:
    <select id="plotax_select">
        <option value="shared_hets">shared hets</option>
        <option value="shared_hom_alts">shared hom-alts</option>
        <option value="concordance">homozygous concordance</option>
        <option value="relatedness">relatedness</option>
        <option value="ibs0" selected>IBS0</option>
        <option value="ibs2">IBS2</option>
    </select>
        Y:
    <select id="plotay_select">
        <option value="shared_hets">shared hets</option>
        <option value="shared_hom_alts">shared hom-alts</option>
        <option value="concordance" selected >homozygous concordance</option>
        <option value="relatedness">relatedness</option>
        <option value="ibs0">IBS0</option>
        <option value="ibs2" selected>IBS2</option>
    </select>

    <div id="plota" style="width: 100%; height: 90%"></div>
</div>

<div class = "six columns">
    <select id="plotb_select">
        <option value="shared_hets">shared hets</option>
        <option value="shared_hom_alts">shared hom-alts</option>
        <option value="concordance" selected >homozygous concordance</option>
        <option value="relatedness">relatedness</option>
        <option value="ibs0">IBS0</option>
        <option value="ibs2">IBS2</option>
    </select>

    <div id="plotb" style="width: 100%; height: 90%"></div>
</div>

    <script>

//input = {"sites_tested":468,"ibs":[0,0,21,21,20,14,13,13,14,12,89,0,20,20,19,14,13,13,15,13,38,39,0,0,0,13,9,11,19,18,35,35,101,0,0,13,9,11,19,18,33,33,100,95,0,13,9,11,17,17,37,36,48,42,45,0,0,0,16,14,33,35,47,41,46,99,0,0,13,12,33,32,43,40,40,94,90,0,15,14,41,43,49,48,46,44,44,38,0,0,37,39,47,46,45,42,42,38,110,0],"n":[0,280,289,284,268,287,255,276,291,279,279,0,282,271,259,278,250,265,282,271,145,147,0,282,270,285,254,274,289,280,143,140,280,0,262,276,246,277,281,272,130,131,267,259,0,264,247,258,269,267,151,148,159,152,144,0,256,270,289,275,133,134,143,138,141,254,0,249,257,254,151,144,152,153,139,269,244,0,275,269,151,153,148,148,140,141,132,136,0,283,147,148,146,146,141,136,129,137,281,0],"hets":[93,93,111,103,104,107,103,98,118,111],"homs":[73,72,79,81,79,74,72,73,71,69],"shared_hom_alts":[0,69,43,45,43,42,42,44,46,45,0,0,42,43,43,42,42,42,45,43,0,0,0,77,76,46,45,46,47,46,0,0,0,0,76,45,46,48,51,49,0,0,0,0,0,44,46,44,47,46,0,0,0,0,0,0,69,70,40,37,0,0,0,0,0,0,0,66,41,39,0,0,0,0,0,0,0,0,43,40,0,0,0,0,0,0,0,0,0,68,0,0,0,0,0,0,0,0,0,0],"samples":["15079X17","15079X2","15079X19","15079X25","15079X22","15079X20","15079X23","15079X26","15079X21","15079X24"],"clusters":[[0,1],[2,3,4],[5,6,7],[8,9]]}
input = {"sites_tested":38399,"ibs":[0,0,8,8,8,6,6,6,9,7,28,0,7,7,7,6,6,6,9,7,7,8,0,0,0,8,6,8,10,9,7,7,34,0,0,8,6,8,9,8,7,8,35,34,0,8,6,8,12,11,13,13,17,17,17,0,0,0,6,6,13,13,17,17,17,37,0,0,4,4,14,14,17,17,17,38,37,0,6,6,11,11,16,16,16,17,16,18,0,0,11,12,17,16,17,17,16,18,34,0],"n":[0,86,92,81,93,89,77,94,93,81,86,0,86,74,85,85,72,87,87,76,38,40,0,82,91,88,76,93,92,80,30,31,82,0,79,77,72,81,80,74,36,36,90,78,0,88,77,94,92,80,44,44,48,40,45,0,77,90,89,78,38,37,39,38,37,77,0,79,77,71,49,46,48,39,46,90,79,0,94,82,45,44,48,41,44,49,43,52,0,83,39,40,43,41,39,42,41,44,82,0],"hets":[28,29,35,34,36,38,37,39,34,35],"homs":[19,19,28,28,28,20,20,20,23,22],"shared_hom_alts":[0,19,10,10,10,9,9,9,9,9,0,0,10,10,10,9,9,9,9,9,0,0,0,28,28,11,11,11,12,12,0,0,0,0,28,11,11,11,12,12,0,0,0,0,0,11,11,11,12,12,0,0,0,0,0,0,20,20,10,9,0,0,0,0,0,0,0,20,10,9,0,0,0,0,0,0,0,0,10,9,0,0,0,0,0,0,0,0,0,22,0,0,0,0,0,0,0,0,0,0],"samples":["15079X17","15079X2","15079X19","15079X22","15079X25","15079X20","15079X23","15079X26","15079X21","15079X24"],"clusters":[["15079X17","15079X2"],["15079X19","15079X22","15079X25"],["15079X20","15079X23","15079X26"],["15079X21","15079X24"]],"expected-relatedness":[{"value":1,"pairs":[["15079X17","15079X2"],["15079X20","15079X23"],["15079X20","15079X26"],["15079X23","15079X26"],["15079X21","15079X24"]]}]}
//input = {"sites_tested":38399,"ibs":[0,1,816,0,0,0,0,0,0,0,0,1,1,1,1,784,758,1939,0,791,274,333,299,417,385,317,311,407,282,425,329,746,734,737,1456,1526,0,1,1,0,1,1,0,0,1,2,1,0,829,0,2,1886,1801,1972,0,148,183,212,199,198,137,121,181,238,188,441,326,339,1901,1807,1943,2556,0,199,189,147,164,196,143,143,162,128,414,357,355,1850,1660,1835,2388,2245,0,166,156,222,159,172,152,210,139,425,354,411,1805,1632,1846,2241,2135,2434,0,137,212,222,183,249,193,221,354,341,393,1888,1707,1859,2252,2330,2274,2454,0,159,228,221,209,276,287,385,339,394,1917,1771,1930,2453,2373,2327,2365,2163,0,120,135,204,132,206,441,359,358,1927,1792,1911,2545,2302,2216,2285,2266,2672,0,168,139,138,169,388,295,451,1945,1759,1902,2376,2223,2211,2464,2346,2452,2504,0,157,148,181,343,357,382,1868,1784,1899,2314,2489,2192,2135,2136,2526,2380,2384,0,159,201,500,476,275,1865,1652,1860,2331,2418,2295,2238,2015,2546,2385,2379,2368,0,115,292,343,455,1827,1685,1886,2342,2354,2334,2280,2127,2348,2335,2317,2375,2439,0,412,400,409,1882,1562,1519,1682,1732,1674,1724,1727,1753,1722,1776,1695,1764,1730,0,777,813,1479,1529,1894,1817,1757,1690,1721,1746,1775,1785,1786,1693,1741,1732,1508,0,790,1436,1528,1845,1743,1764,1642,1552,1655,1716,1677,1713,1786,1721,1723,1500,1535,0],"n":[0,9308,9308,9308,9307,9309,9308,9307,9309,9308,9308,9309,9308,9307,9309,9307,9309,5514,0,9307,9307,9306,9308,9307,9306,9308,9307,9307,9308,9307,9306,9308,9306,9308,3840,3899,0,9307,9307,9308,9307,9306,9308,9307,9307,9308,9308,9306,9308,9306,9308,5357,4806,5530,0,9306,9308,9308,9307,9308,9307,9308,9308,9307,9307,9308,9306,9308,5443,4815,5526,6446,0,9307,9306,9305,9307,9306,9306,9307,9307,9305,9307,9305,9307,5448,4663,5419,6183,5936,0,9308,9307,9309,9308,9308,9309,9308,9307,9309,9307,9309,5354,4484,5437,5857,5722,6451,0,9307,9308,9307,9308,9308,9307,9307,9308,9306,9308,5475,4621,5417,5847,6109,6096,6472,0,9307,9306,9307,9307,9306,9306,9307,9305,9307,5412,4697,5439,6128,6057,6015,6097,5701,0,9308,9308,9309,9308,9307,9309,9307,9309,5455,4766,5422,6396,5905,5878,5949,5859,6659,0,9307,9308,9307,9306,9308,9307,9308,5487,4601,5401,6071,5796,5852,6344,6024,6201,6294,0,9308,9307,9307,9308,9306,9308,5409,4853,5471,5964,6407,5911,5697,5694,6357,6153,6140,0,9308,9307,9309,9307,9309,5399,4442,5389,5937,6241,6055,5955,5380,6465,6159,6134,6178,0,9306,9308,9306,9308,5358,4639,5478,6044,6183,6239,6046,5628,6029,6062,6012,6185,6395,0,9307,9305,9307,5481,3990,3927,4483,4664,4646,4813,4742,4618,4632,4781,4539,4880,4727,0,9307,9309,3881,3923,5494,4858,4760,4737,4809,4816,4732,4839,4776,4548,4772,4732,3922,0,9307,3860,3958,5434,4735,4816,4624,4458,4618,4655,4507,4644,4974,4659,4744,3908,3990,0],"hets":[3783,3889,3782,3940,3885,3778,3781,3826,3948,3925,3928,3852,3856,3820,3808,3818,3780],"homs":[2044,1993,2028,1945,1958,2018,2065,2027,1961,2015,1971,1984,1966,1962,2011,2018,1992],"shared_hom_alts":[0,1270,867,1221,1232,1251,1259,1257,1233,1265,1266,1241,1234,1236,1250,879,873,0,0,866,1077,1062,1073,1038,1058,1032,1077,1037,1067,1005,1069,870,871,884,0,0,0,1218,1249,1252,1272,1251,1233,1247,1231,1242,1217,1262,862,1266,1243,0,0,0,0,1349,1353,1332,1270,1303,1385,1313,1275,1248,1296,964,1063,1057,0,0,0,0,0,1291,1288,1357,1297,1275,1254,1366,1333,1342,1023,1039,1074,0,0,0,0,0,0,1456,1354,1311,1339,1290,1304,1340,1379,1040,1066,1064,0,0,0,0,0,0,0,1449,1377,1358,1417,1276,1324,1364,1095,1099,1039,0,0,0,0,0,0,0,0,1269,1303,1333,1270,1201,1232,1049,1106,1047,0,0,0,0,0,0,0,0,0,1460,1355,1375,1402,1314,1006,1075,1023,0,0,0,0,0,0,0,0,0,0,1387,1364,1342,1337,1038,1097,1013,0,0,0,0,0,0,0,0,0,0,0,1350,1346,1319,1039,1065,1044,0,0,0,0,0,0,0,0,0,0,0,0,1352,1359,982,1009,1120,0,0,0,0,0,0,0,0,0,0,0,0,0,1386,1074,1067,1021,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1055,1052,1052,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,869,830,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,880,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],"samples":["NA12877","NA12890","NA12878","NA12880","NA12881","NA12879","NA12885","NA12887","NA12882","NA12888","NA12886","NA12893","NA12883","NA12884","NA12889","NA12891","NA12892"],"clusters":[["NA12877","NA12890"],["NA12878","NA12880","NA12881"],["NA12879","NA12885","NA12887"],["NA12882","NA12888","NA12886","NA12893","NA12883","NA12884"],["NA12889"],["NA12891"],["NA12892"]]}





input.n_samples = input.samples.length;

var accessors = {
    "ibs0": function (input, i, j) {
        return input.ibs[i * input.n_samples + j]
    },
    "shared_hets": function (input, i, j) {
        return input.ibs[j * input.n_samples + i]
    },
    "ibs2": function (input, i, j) {
        return input.n[j * input.n_samples + i]
    },
    "n": function (input, i, j) {
        return input.n[i * input.n_samples + j]
    },
    "shared_hom_alts": function (input, i, j) {
        return input.shared_hom_alts[i * input.n_samples + j]
    },
    "relatedness": function(input, i, j) {
        return (accessors.shared_hets(input, i, j) - 2 * accessors.ibs0(input, i, j)) / Math.min(input.hets[i], input.hets[j])
    },
    "concordance": function(input, i, j) {
        return accessors.shared_hom_alts(input, i, j) / Math.min(input.homs[i], input.homs[j])
    },
}

function get_heat_data(input, metric) {
    var result = new Array(input.n_samples)
    for (i = 0; i < input.n_samples; i++) {
        result[i] = new Array(input.n_samples)
    }
    var m = accessors[metric]
    for (i = 0; i < input.n_samples; i++) {
        for (j = i + 1; j < input.n_samples; j++) {
            result[i][j] = m(input, i, j)
        }
    }
    return result
}

function getc(rel_pairs, sample_a, sample_b) {
    var c = rel_pairs.get(sample_a + "--" + sample_b)
    //if (c != undefined){ return c}
    //c = rel_pairs.get(sample_b + "--" + sample_a)
    if (c == undefined) {
        c = 0
    } 
    return c
}

function get_xy_data_by_group(input, metric, rel_pairs) {
    var result = []
    var m = accessors[metric]
    for(i = 0; i < input.n_samples - 1; i++) {
        for(j=i+1; j < input.n_samples; j++){
            var c = getc(rel_pairs, input.samples[i], input.samples[j])
            if (result[c] == undefined) {
                result[c] = []
            }
            var v = m(input, i, j)
            //if (v < 15) {
            //    v += (Math.random() - 0.5) / (7.0 * (v + 1))
            //}
            result[c].push(v)
        }
    }
    return result
}

function get_xy_samples(input) {
    var result = []
    for(i = 0; i < input.n_samples - 1; i++) {
        for(j=i+1; j < input.n_samples; j++){
            // TODO: might need to flip these.
            result.push(input.samples[i] + " <> " + input.samples[j])
        }
    }
    return result
}

var colors = ['#377eb8bb', '#e41a1cbb', '#4daf4a', '#984ea3', '#ff7f00', '#ffff33', '#a65628', '#f781bf', '#999999', '#e41a1c', '#377eb8', '#4daf4a']

function get_colors(input, colormap) {
    var result = []
    for(i = 0; i < input.n_samples - 1; i++) {
        for(j=i+1; j < input.n_samples; j++){
            var c = getc(colormap, input.samples[i], input.samples[j])
            result.push(colors[c])
        }
    }
    return result
}

var colorscaleValue = [
  [0,   '#3D9970'],
  [0.4,   '#2D8960'],
  [0.8, '#011e3e'],
  [1,   '#001f3f']
];

var metric_b = jQuery("#plotb_select").val()

var sample_pairs = get_xy_samples(input)

var heat_data = {
    z: get_heat_data(input, metric_b),
    type: 'heatmap',
    x: input.samples,
    colorscale: colorscaleValue,
    y: input.samples,
    zsmooth: false,
}

var layout_b = {
    title: jQuery("#plotb_select option:selected").text(),
    autosize: true,
    xaxis: {
        tickangle: 90,
    },
    hovermode: 'closest',
    shapes: [],
}

// add the rectangles around each cluster.
var coff = 0
input.clusters.forEach(function(cluster) {
    if(cluster.length == 1) { 
        coff += 1
        return 
    }
    layout_b.shapes.push({
        type: "rect",
        xref: "x",
        yref: "y",
        x0: coff - 0.5,
        y0: coff - 0.5,
        x1: coff + cluster.length - 0.5,
        y1: coff + cluster.length - 0.5,
        //fillcolor: '#d3d3d3',
        //opacity: 0.5,
        line: {width: 1.8, color: '#a41414'},
    })
    coff += cluster.length

});

var traces_b = []
var traces_a = []


var rel_pairs = new Map()
var rel_pairs_value_2_rel = new Map()
rel_pairs_value_2_rel.set(0, 0)
if ("expected-relatedness" in input) {
    var er = input["expected-relatedness"]
    var found = new Map()
    for(i in er){
        var v = er[i] // v.value and v.pairs
        rel_pairs_value_2_rel.set(parseInt(i) + 1, v.value)
        for(j in v.pairs){
            rel_pairs.set(v.pairs[j][0] + "--" + v.pairs[j][1], parseInt(i)+1)
        }
    }
}


var layout_a = {
    autosize: true,
    xaxis: {
        title: jQuery("#plotax_select option:selected").text(),
    },
    yaxis: {
        title: jQuery("#plotay_select option:selected").text(),
    },
    hovermode: 'closest',
    showlegend: true,
}

x_data = get_xy_data_by_group(input, jQuery('#plotax_select').val(), rel_pairs)
y_data = get_xy_data_by_group(input, jQuery('#plotay_select').val(), rel_pairs)

var traces_a = []
for (i in x_data) {

    traces_a.push({
        name: "relatedness " + rel_pairs_value_2_rel.get(parseInt(i)),
        x: x_data[i],
        y: y_data[i],
        text: sample_pairs,
        type: 'scatter',
        mode: 'markers',
        marker: {size: 12, color:colors[i]},
        showlegend:true,
    })
}

traces_b.push(heat_data)

Plotly.newPlot('plotb', traces_b, layout_b)
Plotly.newPlot('plota', traces_a, layout_a)

jQuery('#plotb_select').on('change', function() {
    var metric = this.value
    layout_b.title = jQuery("#plotb_select option:selected").text();
    heat_data.z = get_heat_data(input, metric)
    Plotly.redraw('plotb')
})
jQuery('#plotax_select').on('change', function() {
    var metric = this.value
    layout_a.xaxis.title = jQuery("#plotax_select option:selected").text();
    x_data = get_xy_data_by_group(input, jQuery('#plotax_select').val(), rel_pairs)
    for (i in x_data) {
        traces_a[i].x = x_data[i]
    }

    Plotly.redraw('plota')
})

jQuery('#plotay_select').on('change', function() {
    var metric = this.value
    layout_a.yaxis.title = jQuery("#plotay_select option:selected").text();
    y_data = get_xy_data_by_group(input, jQuery('#plotay_select').val(), rel_pairs)
    for (i in y_data) {
        traces_a[i].y = y_data[i]
    }
    Plotly.redraw('plota')
})

window.onresize = function() {
    Plotly.Plots.resize('plota');
    Plotly.Plots.resize('plotb');
};
</script>
</body>
</html>
