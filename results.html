<html>
<head>
    <link href="style.css" media="all" rel="stylesheet" data-target="desktop"/>
    <script src="plotly-latest.min.js"></script>
    <script src="jquery.min.js"></script>
</head>
<body>

<div class = "six columns">
        X:
    <select id="plotax_select">
        <option value="shared_hets">shared hets</option>
        <option value="shared_hom_alts">shared hom-alts</option>
        <option value="concordance">homozygous concordance</option>
        <option value="relatedness">relatedness</option>
        <option value="ibs0" selected>IBS0</option>
        <option value="ibs2">IBS2</option>
    </select>
        Y:
    <select id="plotay_select">
        <option value="shared_hets">shared hets</option>
        <option value="shared_hom_alts">shared hom-alts</option>
        <option value="concordance" selected >homozygous concordance</option>
        <option value="relatedness">relatedness</option>
        <option value="ibs0">IBS0</option>
        <option value="ibs2" selected>IBS2</option>
    </select>

    <div id="plota" style="width: 100%; height: 90%"></div>
</div>

<div class = "six columns">
    <select id="plotb_select">
        <option value="shared_hets">shared hets</option>
        <option value="shared_hom_alts">shared hom-alts</option>
        <option value="concordance" selected >homozygous concordance</option>
        <option value="relatedness">relatedness</option>
        <option value="ibs0">IBS0</option>
        <option value="ibs2">IBS2</option>
    </select>

    <div id="plotb" style="width: 100%; height: 90%"></div>
</div>

    <script>

input = {"sites_tested":468,"ibs":[0,0,21,21,20,14,13,13,14,12,89,0,20,20,19,14,13,13,15,13,38,39,0,0,0,13,9,11,19,18,35,35,101,0,0,13,9,11,19,18,33,33,100,95,0,13,9,11,17,17,37,36,48,42,45,0,0,0,16,14,33,35,47,41,46,99,0,0,13,12,33,32,43,40,40,94,90,0,15,14,41,43,49,48,46,44,44,38,0,0,37,39,47,46,45,42,42,38,110,0],"n":[0,280,289,284,268,287,255,276,291,279,279,0,282,271,259,278,250,265,282,271,145,147,0,282,270,285,254,274,289,280,143,140,280,0,262,276,246,277,281,272,130,131,267,259,0,264,247,258,269,267,151,148,159,152,144,0,256,270,289,275,133,134,143,138,141,254,0,249,257,254,151,144,152,153,139,269,244,0,275,269,151,153,148,148,140,141,132,136,0,283,147,148,146,146,141,136,129,137,281,0],"hets":[93,93,111,103,104,107,103,98,118,111],"homs":[73,72,79,81,79,74,72,73,71,69],"shared_hom_alts":[0,69,43,45,43,42,42,44,46,45,0,0,42,43,43,42,42,42,45,43,0,0,0,77,76,46,45,46,47,46,0,0,0,0,76,45,46,48,51,49,0,0,0,0,0,44,46,44,47,46,0,0,0,0,0,0,69,70,40,37,0,0,0,0,0,0,0,66,41,39,0,0,0,0,0,0,0,0,43,40,0,0,0,0,0,0,0,0,0,68,0,0,0,0,0,0,0,0,0,0],"samples":["15079X17","15079X2","15079X19","15079X25","15079X22","15079X20","15079X23","15079X26","15079X21","15079X24"],"clusters":[[0,1],[2,3,4],[5,6,7],[8,9]]}
input = {"sites_tested":38399,"ibs":[0,0,8,8,8,6,6,6,9,7,28,0,7,7,7,6,6,6,9,7,7,8,0,0,0,8,6,8,10,9,7,7,34,0,0,8,6,8,9,8,7,8,35,34,0,8,6,8,12,11,13,13,17,17,17,0,0,0,6,6,13,13,17,17,17,37,0,0,4,4,14,14,17,17,17,38,37,0,6,6,11,11,16,16,16,17,16,18,0,0,11,12,17,16,17,17,16,18,34,0],"n":[0,86,92,81,93,89,77,94,93,81,86,0,86,74,85,85,72,87,87,76,38,40,0,82,91,88,76,93,92,80,30,31,82,0,79,77,72,81,80,74,36,36,90,78,0,88,77,94,92,80,44,44,48,40,45,0,77,90,89,78,38,37,39,38,37,77,0,79,77,71,49,46,48,39,46,90,79,0,94,82,45,44,48,41,44,49,43,52,0,83,39,40,43,41,39,42,41,44,82,0],"hets":[28,29,35,34,36,38,37,39,34,35],"homs":[19,19,28,28,28,20,20,20,23,22],"shared_hom_alts":[0,19,10,10,10,9,9,9,9,9,0,0,10,10,10,9,9,9,9,9,0,0,0,28,28,11,11,11,12,12,0,0,0,0,28,11,11,11,12,12,0,0,0,0,0,11,11,11,12,12,0,0,0,0,0,0,20,20,10,9,0,0,0,0,0,0,0,20,10,9,0,0,0,0,0,0,0,0,10,9,0,0,0,0,0,0,0,0,0,22,0,0,0,0,0,0,0,0,0,0],"samples":["15079X17","15079X2","15079X19","15079X22","15079X25","15079X20","15079X23","15079X26","15079X21","15079X24"],"clusters":[["15079X17","15079X2"],["15079X19","15079X22","15079X25"],["15079X20","15079X23","15079X26"],["15079X21","15079X24"]],"expected-relatedness":[{"value":1,"pairs":[["15079X17","15079X2"],["15079X20","15079X23"],["15079X20","15079X26"],["15079X23","15079X26"],["15079X21","15079X24"]]}]}




input.n_samples = input.samples.length;

var accessors = {
    "ibs0": function (input, i, j) {
        return input.ibs[i * input.n_samples + j]
    },
    "shared_hets": function (input, i, j) {
        return input.ibs[j * input.n_samples + i]
    },
    "ibs2": function (input, i, j) {
        return input.n[j * input.n_samples + i]
    },
    "n": function (input, i, j) {
        return input.n[i * input.n_samples + j]
    },
    "shared_hom_alts": function (input, i, j) {
        return input.shared_hom_alts[i * input.n_samples + j]
    },
    "relatedness": function(input, i, j) {
        return (accessors.shared_hets(input, i, j) - 2 * accessors.ibs0(input, i, j)) / Math.min(input.hets[i], input.hets[j])
    },
    "concordance": function(input, i, j) {
        return accessors.shared_hom_alts(input, i, j) / Math.min(input.homs[i], input.homs[j])
    },
}

function get_heat_data(input, metric) {
    var result = new Array(input.n_samples)
    for (i = 0; i < input.n_samples; i++) {
        result[i] = new Array(input.n_samples)
    }
    var m = accessors[metric]
    for (i = 0; i < input.n_samples; i++) {
        for (j = i + 1; j < input.n_samples; j++) {
            result[i][j] = m(input, i, j)
        }
    }
    return result
}

function get_xy_data(input, metric) {
    var result = []
    var m = accessors[metric]
    for(i = 0; i < input.n_samples - 1; i++) {
        for(j=i+1; j < input.n_samples; j++){
            result.push(m(input, i, j))
        }
    }
    return result
}

function getc(rel_pairs, sample_a, sample_b) {
    var c = rel_pairs.get(sample_a + "--" + sample_b)
    //if (c != undefined){ return c}
    //c = rel_pairs.get(sample_b + "--" + sample_a)
    if (c == undefined) {
        c = 0
    } 
    return c
}

function get_xy_data_by_group(input, metric, rel_pairs) {
    var result = []
    var m = accessors[metric]
    for(i = 0; i < input.n_samples - 1; i++) {
        for(j=i+1; j < input.n_samples; j++){
            var c = getc(rel_pairs, input.samples[i], input.samples[j])
            if (result[c] == undefined) {
                result[c] = []
            }
            result[c].push(m(input, i, j))
        }
    }
    return result
}

function get_xy_samples(input) {
    var result = []
    for(i = 0; i < input.n_samples - 1; i++) {
        for(j=i+1; j < input.n_samples; j++){
            // TODO: might need to flip these.
            result.push(input.samples[i] + " <> " + input.samples[j])
        }
    }
    return result
}

var colors = ['#377eb8', '#e41a1c', '#4daf4a', '#984ea3', '#ff7f00', '#ffff33', '#a65628', '#f781bf', '#999999', '#e41a1c', '#377eb8', '#4daf4a']

function get_colors(input, colormap) {
    var result = []
    for(i = 0; i < input.n_samples - 1; i++) {
        for(j=i+1; j < input.n_samples; j++){
            var c = getc(colormap, input.samples[i], input.samples[j])
            result.push(colors[c])
        }
    }
    return result
}

var colorscaleValue = [
  [0,   '#3D9970'],
  [0.4,   '#2D8960'],
  [0.8, '#011e3e'],
  [1,   '#001f3f']
];

var metric_b = jQuery("#plotb_select").val()

var sample_pairs = get_xy_samples(input)

var heat_data = {
    z: get_heat_data(input, metric_b),
    type: 'heatmap',
    x: input.samples,
    colorscale: colorscaleValue,
    y: input.samples,
    zsmooth: false,
}

var layout_b = {
    title: jQuery("#plotb_select option:selected").text(),
    autosize: true,
    xaxis: {
        tickangle: 90,
    },
    hovermode: 'closest',
    shapes: [],
}

// add the rectangles around each cluster.
var coff = 0
input.clusters.forEach(function(cluster) {
    if(cluster.length == 1) { 
        coff += 1
        return 
    }
    layout_b.shapes.push({
        type: "rect",
        xref: "x",
        yref: "y",
        x0: coff - 0.5,
        y0: coff - 0.5,
        x1: coff + cluster.length - 0.5,
        y1: coff + cluster.length - 0.5,
        //fillcolor: '#d3d3d3',
        //opacity: 0.5,
        line: {width: 1.8, color: '#a41414'},
    })
    coff += cluster.length

});

var traces_b = []
// TODO: have to add these as we see them in separate traces so they can be turned on/off as a group.
var traces_a = []


var rel_pairs = new Map()
var rel_pairs_value_2_rel = new Map()
rel_pairs_value_2_rel.set(0, 0)
if ("expected-relatedness" in input) {
    var er = input["expected-relatedness"]
    var found = new Map()
    for(i in er){
        var v = er[i] // v.value and v.pairs
        rel_pairs_value_2_rel.set(parseInt(i) + 1, v.value)
        for(j in v.pairs){
            rel_pairs.set(v.pairs[j][0] + "--" + v.pairs[j][1], parseInt(i)+1)
        }
    }
}


var layout_a = {
    //title: jQuery("#plotb_select option:selected").text(),
    autosize: true,
    xaxis: {
        title: jQuery("#plotax_select option:selected").text(),
    },
    yaxis: {
        title: jQuery("#plotay_select option:selected").text(),
    },
    hovermode: 'closest',
    showlegend: true,
}

x_data = get_xy_data_by_group(input, jQuery('#plotax_select').val(), rel_pairs)
y_data = get_xy_data_by_group(input, jQuery('#plotay_select').val(), rel_pairs)

var traces_a = []
for (i in x_data) {

    traces_a.push({
        name: "relatedness " + rel_pairs_value_2_rel.get(parseInt(i)),
        x: x_data[i],
        y: y_data[i],
        text: sample_pairs,
        type: 'scatter',
        mode: 'markers',
        marker: {size: 12, color:i},
        showlegend:true,
    })
}

traces_b.push(heat_data)

Plotly.newPlot('plotb', traces_b, layout_b)
Plotly.newPlot('plota', traces_a, layout_a)

jQuery('#plotb_select').on('change', function() {
    var metric = this.value
    layout_b.title = jQuery("#plotb_select option:selected").text();
    heat_data.z = get_heat_data(input, metric)
    Plotly.redraw('plotb')
})
jQuery('#plotax_select').on('change', function() {
    var metric = this.value
    layout_a.xaxis.title = jQuery("#plotax_select option:selected").text();
    x_data = get_xy_data_by_group(input, jQuery('#plotax_select').val(), rel_pairs)
    for (i in x_data) {
        traces_a[i].x = x_data[i]
    }

    Plotly.redraw('plota')
})

jQuery('#plotay_select').on('change', function() {
    var metric = this.value
    layout_a.yaxis.title = jQuery("#plotay_select option:selected").text();
    y_data = get_xy_data_by_group(input, jQuery('#plotay_select').val(), rel_pairs)
    for (i in y_data) {
        traces_a[i].y = y_data[i]
    }
    Plotly.redraw('plota')
})

window.onresize = function() {
    Plotly.Plots.resize('plota');
    Plotly.Plots.resize('plotb');
};
</script>
</body>
</html>
